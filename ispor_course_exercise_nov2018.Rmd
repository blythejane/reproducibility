---
title: "ISPOR Exercise"
subtitle: "Tools for Reproducible Real-World Analyses"
author: "Tom Riddle"
output:   
  html_document:
    theme: yeti
    highlight: tango
    code_folding: hide
    toc: true
    toc_float: true
---

__Author:__ @`r Sys.getenv("USER")`

__Date created:__ 5 November 2018

__Date generated:__ `r Sys.Date()`  

__Generated by:__ `r Sys.info()[8]`  
   
__Code review:__ In Progress

__Link to accompanying instructions:__ [exercise link here](www.blytheadamson.com/tools)

__Output:__ [insert filepath for knitr output]() 

***

# __Goal of the Exercise__
This analysis needs a code review by attendees at the short course "Tools for Reproducible Real 
World Analyses" at ISPOR Europe 2018. You will need to use:

+ Problem solving (including attention to detail)  
+ Communication (written)  
+ Technical skills  

```{r global_options, include=FALSE, results = 'hide'}
knitr::opts_chunk$set(fig.width  = 8, 
                      fig.height = 8, 
                      echo       = TRUE, 
                      warning    = FALSE, 
                      message    = FALSE)

# disable scientific notation
options(scipen = 999)

library(dplyr)
library(knitr)
library(tidyr)
library(DT)
library(highcharter)
library(lubridate)
library(zoo)
library(broom)

```

***  
```{r objective, echo = FALSE}
skill <- c('Write clearly', "Catch Mistakes", 'Use Functions')

beginner <- c('Do results make sense at a high level, i.e. pass a gut check & have face validity?','Find one mistake','Add a DocString to one function')

expert <- c('Is it documented well enough that others could pick it up when you’re on vacation and know exactly why you did what you did?','Write code to answer research question 2','Write a function to answer a new question')

objective <- data.frame(cbind(skill, beginner, expert)) %>%
  rename(`Skill` = skill, 
         `Beginner Challenge` = beginner, 
         `Expert Challenge` = expert) 

kable(objective)
```


***

# __Data Analysis Questions__
```{r import data, echo = FALSE}
# Step 1: Open .RData
load("flatiron_ispor_tables.RData")

# Step 2: Clean Data
# Step 2A: missing values are read in as empty character set ''; convert these to NA 
ConvertToNA <- function(value) {
  ifelse(value == "", NA, value)
}

# Step 2B: convert all date variables to data stored objects
#         since data is in format day-Mon-Year; need to specify non-standard format to R
ConvertToDate <- function(value) {
  as.Date(value, format = "%d-%b-%Y")
}

ApplyTransformation <- function(named_tbl_df) {
  named_tbl_df <- 
    named_tbl_df %>%
      mutate_each(funs(ConvertToNA)) %>%
      mutate_each(funs(ConvertToDate), matches("date"))
  return(named_tbl_df)
}

# loop to apply all transformation to all environmental objects ending in .df
for (df in ls(pattern = ".df")) {
  assign(df, ApplyTransformation(get(df)))
}

# Step 2C: convert age to a numeric varibale 
# Step 2D: convert NA values for gender to "unknown" since it's an existing, distinct value
# Step 2E: convert misspelled "unknown" to "unknown"
demographics.df <- 
  demographics.df %>%
    mutate(age = as.character(age)) %>%
    mutate(gender = ifelse(is.na(gender), "unknown", gender))

# Step 2F: remap clients.df column "external_practice_id" to "internal_practice_id" 
#         since the column values match exactly
names(clients.df)[2] <- "internal_practice_id"

# Step 2G: deal with any duplicate patients in patients table
duplicate.patients <- patients.df %>% 
  group_by(patient_id) %>% 
  count() %>% arrange(desc(n)) %>% 
  filter(n > 1) %>% 
  select(patient_id)

# remove duplicate patients
deduped.patients.df <-
  patients.df %>% 
    group_by(patient_id) %>% 
    sample_n(1) %>% 
    ungroup()

# Step 2H: deal with any duplicate patients in demographics table
duplicate.demographics <- demographics.df %>% 
  group_by(patient_id) %>% 
  count() %>% arrange(desc(n)) %>% 
  filter(n > 1) %>% 
  select(patient_id)

# remove duplicate patients
deduped.demographics.df <-
  demographics.df %>% 
    group_by(patient_id) %>% 
    arrange(race) %>% 
    top_n(1) %>%
    ungroup()

# Step 3: create one wide dataframe joining all objects together to make it easier to analyze data
combined.df <-
  deduped.patients.df %>%
    left_join(clients.df) %>%
    left_join(deduped.demographics.df) %>%
    left_join(admins.df) %>%
    full_join(orders.df) # it's possible orders/admins are not linked so want 
#                           to include any non-matched orders
```

## Question 1
#### __What is the average time elapsed between a patient’s initial diagnosis date and a patient’s first treatment?__


```{r question 1a}
# NOTES/ODDITIES:
# - Not all patients have initial diagnosis date, but some of those patients have admins ...
#   They will be excluded from this analysis 

# ASSUMPTIONS:
# - Assume treatment is being based on administration date; it's possible orders never actually get filled 
# - Filter out any patients with diagnosis date in the future
# - Filter out any cases where the minimum/first administration date pre-dates the initial diagnosis
#   date
# - Remove admins that take place in the future

time.breakdown.table <-
  combined.df %>%
    filter(diagnosis_date < Sys.Date()) %>%
    group_by(patient_id) %>%
    filter(administered_date >= diagnosis_date,
           administered_date <= Sys.Date()) %>% 
    filter(administered_date == min(administered_date)) %>%
    mutate(elapsed_time = administered_date - diagnosis_date) %>%
    ungroup() %>%
    summarise(avg_time = round(mean(elapsed_time, na.rm = TRUE), 0),
              patient_count = n()) 
```

The average time elapsed from diagnosis to first treatment was 
`r time.breakdown.table$avg_time[[1]]` days (n = `r time.breakdown.table$patient_count[[1]]`).

<br>

#### __Does this time vary by gender?__

```{r question 1b}

# using admin
gender.breakdown.table <-
  combined.df %>%
    filter(diagnosis_date < Sys.Date()) %>%
    group_by(patient_id) %>%
    filter(administered_date >= diagnosis_date,
           administered_date <= Sys.Date()) %>% 
    filter(administered_date == min(administered_date)) %>%
    group_by(gender) %>%
    mutate(elapsed_time = administered_date - diagnosis_date) %>%
    summarise(avg_time = mean(elapsed_time, na.rm = TRUE),
              patient_count = n()) %>% 
    cbind(data_frame(population = "assumption_set_1"))

# General Function to produce some highcharts
GenerateHighchart <- function(active_df, title, subtitle, x_data_col, y_data_col, series_name, 
                              y_axis_name, ...) {
  # Generates a highchart HTML widget bar-chart
  #
  # Args:
  #   active_df: data_frame or tbl_df object containing tabular data for plotting
  #   title: large title for highchart
  #   subtitle: small subtitle text for highchart
  #   x_data_col: quoted column name in data_frame/tbl_df containing x-axis data set
  #   y_data_col: quoted column name in data_frame/tbl_df containing y-axis data set
  #   series_name: data series label for high-charts
  #   y_axis_name: x-axis label 
  #   ... : optional parameters to pass to highchart()
  #
  # Returns: HTML widget high-chart
  #   
  x.data.vector <- active_df[, x_data_col]
  y.data.vector <- active_df[, y_data_col]
  series.name.vector <- active_df[, series_name]
  
  FlatironPal <- function() {
    return(c("#69A9D7", "#52BFA2", "#FF7B74", "#FFC274", "#000000"))
  }
  
  highchart() %>%
    hc_title(text = title) %>% 
    hc_subtitle(text = subtitle) %>%
    hc_add_series_labels_values(x.data.vector, y.data.vector, name = series_name, 
                                type = "column", colorByPoint = TRUE) %>%
    hc_xAxis(categories = list(tet = series.name.vector)) %>%
    hc_yAxis(title = list(text = y_axis_name)) %>%
    hc_legend(enabled = FALSE) %>% 
    hc_plotOptions(groupPadding = 0,
                   pointPadding = 0,
                   borderWidth = 2) %>%
    hc_chart(backgroundColor = '#ffffff',
             spacingLeft = 50) %>%
    hc_colors(FlatironPal()) %>%
    hc_tooltip(...)
}  

# Generate table to plot
chart.data <-
  gender.breakdown.table %>% 
    gather(variable, value, -gender, -population) %>%
    filter(variable == "avg_time") %>%
    select(gender, value, population) %>%
    mutate(value = round(value, 0))

# Plot chart and datatable
GenerateHighchart(active_df = chart.data[1:3,],  
                  title = "Average # of Days From Initial Diagnosis to First Treatment Date",
                  subtitle = "By Gender",
                  x_data_col = "gender",
                  y_data_col = "value", 
                  series_name = "population",
                  y_axis_name = "Days",
                  pointFormat = "{point.y} Days") %>% 
  hc_xAxis(title = list(text = "Assumpion Set 1"))

datatable(gender.breakdown.table, 
          options = list(dom = 'T'),
          rownames = FALSE,
          colnames = c("Gender", "Average Time (Days)", "Patient Count", "Population")) %>%
  formatRound("avg_time", digits = 0)
```

<br><br>

***

## Question 2
#### __How many patients are on nivolumab from 2012-2016?__
     
```{r question 2}
# insert code here for an expert challenge
```

<br><br>

***
## R Code Session Information
***

Session information:
```{r ses_info}
sessionInfo()
```


Location of script used to generate this report:
```{r}
getwd()
```